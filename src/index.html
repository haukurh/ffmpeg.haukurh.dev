<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FFmpeg generator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Web app that helps you build FFmpeg commands, with some sensible defaults for web videos">
    <link rel="shortcut icon" href="/favicon.ico">
    <style>
        * {
            box-sizing: border-box;
        }
        html, body {
            font-size: 18px;
            padding: 0;
            margin: 0;
            font-family: sans-serif;
        }
        body {
            min-height: 100vh;
        }
        main {
            margin: 0 auto;
            padding: 1rem;
            max-width: 920px;
        }
        footer {
            text-align: center;
            font-size: .8rem;
            font-style: italic;
            padding: 2rem 0;
        }
        #messages {
            position: fixed;
            transition: all 400ms ease-in-out;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            bottom: 1rem;
            left: 0;
            right: 0;
            pointer-events: none;
        }
        .subtitle {
            font-size: .6rem;
        }
        #cli {
            display: block;
            margin: 1rem 0;
        }

        .message {
            display: block;
            padding: .8rem 1.2rem;
            background-color: #27AE60;
            color: #ffffff;
            margin: .4rem 0;
            visibility: visible;
            transition: all 400ms ease-in-out;
            border: 1px solid #21a85a;
            border-radius: 5px;
            box-shadow: 1px 1px 7px -3px rgba(0, 0, 0, .6);
            animation: fade-in 0.8s cubic-bezier(0.390, 0.575, 0.565, 1.000) both;
            animation-fill-mode: forwards !important;
        }

        .hide {
            animation: fade-out 1s ease-out both;
        }

        .p40 {
            padding: .4rem 0;
        }

        @keyframes fade-in {
            0% {
                opacity: 0;
            }
            100% {
                opacity: 1;
            }
        }

        @keyframes fade-out {
            0% {
                opacity: 1;
            }
            100% {
                opacity: 0;
                pointer-events: none;
                visibility: hidden;
            }
        }
    </style>
</head>
<body>

<main>
    <h1>FFmpeg generator</h1>
    <form id="ffmpeg">
        <label for="input">Video clip</label>
        <input type="file" id="input" name="input">
        <div><span class="subtitle">Drag your video file here</span></div>
        <div class="video">
            <h2>Video</h2>
            <label for="vcodec">codec:</label>
            <select id="vcodec" name="vcodec">
                <option value="vn">none</option>
                <option value="copy">copy</option>
                <option value="libx264" selected>libx264</option>
            </select>
            <label for="crf">CRF</label>
            <input type="number" name="crf" id="crf" value="18" min="0" max="64" step="3" class="vcodec">
            <label for="preset">Preset</label>
            <select id="preset" name="preset" class="vcodec">
                <option value="ultrafast">ultrafast</option>
                <option value="superfast">superfast</option>
                <option value="veryfast">veryfast</option>
                <option value="faster">faster</option>
                <option value="fast">fast</option>
                <option value="medium">medium</option>
                <option value="slow">slow</option>
                <option value="slower">slower</option>
                <option value="veryslow" selected>veryslow</option>
                <option value="placebo">placebo (silly option)</option>
            </select>
            <label for="profile">Profile</label>
            <select id="profile" name="profile" class="vcodec">
                <option value="ffmpeg">Let ffmpeg decide</option>
                <option value="baseline">baseline</option>
                <option value="main">main</option>
                <option value="high" selected>high</option>
            </select>
            <label for="level">Level</label>
            <select id="level" name="level" class="vcodec">
                <option value="ffmpeg">Let ffmpeg decide</option>
                <option value="1">1</option>
                <option value="1b">1b</option>
                <option value="1.1">1.1</option>
                <option value="1.2">1.2</option>
                <option value="2">2</option>
                <option value="2.1">2.1</option>
                <option value="2.2">2.2</option>
                <option value="3">3</option>
                <option value="3.1">3.1</option>
                <option value="3.2">3.2</option>
                <option value="4">4</option>
                <option value="4.1">4.1</option>
                <option value="4.2" selected>4.2</option>
                <option value="5">5</option>
                <option value="5.1">5.1</option>
                <option value="5.2">5.2</option>
                <option value="6">6</option>
                <option value="6.1">6.1</option>
                <option value="6.2">6.2</option>
            </select>
            <div class="p40">
                <label for="faststart">web video</label>
                <input type="checkbox" id="faststart" name="faststart" value="true" class="vcodec" checked>
                <label for="yuv420p">YUV 4:2:0 chroma subsampling (for dumb players)</label>
                <input type="checkbox" id="yuv420p" name="yuv420p" value="true" class="vcodec" checked>
            </div>
            <div>
                <h3>filters</h3>
                <label for="resize">resize</label>
                <input type="checkbox" id="resize" name="resize" value="true" class="vcodec">
                <span>width: <span id="width"></span></span>
                <label for="height">height</label>
                <input type="number" id="height" name="height" class="vcodec resize" min="0">
                <br>
                <label for="fps">fps:</label>
                <select name="fps" id="fps" class="vcodec">
                    <option value="-1">Don't change</option>
                    <option value="10">10</option>
                    <option value="16">16</option>
                    <option value="24">24</option>
                    <option value="30">30</option>
                    <option value="60">60</option>
                </select>
            </div>
        </div>
        <div class="audio">
            <h2>Audio</h2>
            <label for="acodec">codec:</label>
            <select id="acodec" name="acodec">
                <option value="an">none</option>
                <option value="copy">copy</option>
                <option value="aac-ffmpeg" selected>aac (let ffmpeg decide)</option>
                <option value="aac">aac</option>
            </select>
            <label for="ba">bitrate</label>
            <input type="number" id="ba" name="ba" step="32" value="96" min="32" max="512" class="acodec"> kbps
        </div>
        <div class="metadata">
            <h2>Metadata</h2>
            <label for="strip">strip previous metadata</label>
            <input type="checkbox" id="strip" name="strip" value="true" checked>
            <label for="create">include create time</label>
            <input type="checkbox" id="create" name="create" value="true" checked>
            <label for="title">title</label>
            <input type="text" name="title" id="title" placeholder="Video of the year" autocomplete="off">
            <label for="vlang">video:</label>
            <select id="vlang" name="vlang">
                <option value="ice">Icelandic</option>
                <option value="eng">English</option>
            </select>
            <label for="alang">audio:</label>
            <select id="alang" name="alang">
                <option value="ice">Icelandic</option>
                <option value="eng">English</option>
            </select>
        </div>
        <div class="container">
            <h2>Format</h2>
            <label for="filename">filename</label>
            <input type="text" id="filename" name="filename" style="width: 320px">
            <label for="format">format</label>
            <select id="format" name="format">
                <option value="mp4">mp4</option>
            </select>
        </div>
        <div class="command">
            <h2>command</h2>
            <code id="cli"></code>
            <button type="button" id="copy">copy</button>
        </div>
    </form>
</main>
<footer>Check this project on <a href="https://github.com/haukurh/ffmpeg.haukurh.dev" target="_blank" rel="noreferrer">github</a></footer>
<div id="messages"></div>

<script src="https://cdn.haukurh.dev/moov/v0.0.1/moov-min.js"></script>
<script>
    const readFile = async (file) => {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();

            reader.onload = (e) => {
                resolve(new Uint8Array(e.target.result));
            }

            reader.onerror = (e) => {
                reject(e);
            }

            reader.readAsArrayBuffer(file);
        });
    };

    let movie = null;
    const time = (new Date()).toISOString();
    const heightEl = document.getElementById('height');
    document.getElementById('input').addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (['video/quicktime', 'video/mp4'].includes(file.type)) {
            readFile(event.target.files[0]).then((file) => {
                movie = moovAtom.readMovieAtom(file);
                console.log(movie);
                movie.tracks.forEach((track) => {
                    if (track.header && track.header.trackHeight) {
                        heightEl.value = track.header.trackHeight;
                    }
                });
            });
        }
    });
    const selectAll = (query) => document.querySelectorAll(query);
    const getFormData = (formId) => {
        const form = new FormData(document.getElementById(formId));
        return Object.fromEntries(form);
    };
    const wait = async (callback, time) => {
        return new Promise(resolve => {
            setTimeout(() => {
                resolve(callback());
            }, time);
        });
    };

    const message = (msg, classes) => {
        const body = document.getElementById('messages');
        let modal = document.createElement('div');
        const hide = () => {
            wait(() => modal.classList.add('hide'), 4000)
                .then(() => {});
        }
        modal.classList.add('message');
        modal.innerText = msg;
        wait(() => body.appendChild(modal), 0)
            .then(() => hide())
    };
    const copy = async text => {
        navigator.clipboard.writeText(text)
            .then(() => console.log(`Copied '${text}' to clipboard`))
            .catch(() => console.error(`Unable to copy '${text}' to clipboard`));
    }
    const tokenize = (str) => {
        let token = str.toLowerCase().split(' ').join('-');
        if (token.includes('.')) {
            const tmp = token.split('.');
            tmp.pop();
            token = tmp.join('.');
        }
        return token;
    };
    const handle = () => {
        const preData = getFormData('ffmpeg');
        const cli = document.getElementById('cli');

        const hasVideo = preData.vcodec !== 'vn';
        const hasVideoCode = preData.vcodec !== 'vn' && preData.vcodec !== 'copy';
        const hasResize = preData.resize === 'true' && hasVideoCode;
        const hasFPS = preData.fps !== '-1' && hasVideoCode;
        const hasVideoFilters = hasResize || hasFPS;
        const hasAudio = preData.acodec !== 'an';
        const hasAudioCode = preData.acodec !== 'an' && preData.acodec !== 'copy' && preData.acodec !== 'aac-ffmpeg';

        selectAll('.vcodec').forEach((el) => el.disabled = !hasVideoCode);
        selectAll('.acodec').forEach((el) => el.disabled = !hasAudioCode);
        selectAll('.resize').forEach((el) => el.disabled = !hasResize);
        const data = getFormData('ffmpeg');
        data.acodec = data.acodec === 'aac-ffmpeg' ? 'aac' : data.acodec;

        let command = ['ffmpeg', '-i'];
        const flags = ['-flags'];

        if (data.filename.length === 0 && data.input && data.input.name.length > 0) {
            const tokenFilename = tokenize(data.input.name);
            document.getElementById('filename').value = tokenFilename;
            data.filename = tokenFilename;
        }

        const output = `"${data.filename}.${data.format}"`;
        command.push(`"${data.input.name}"`);

        if (hasVideo) {
            command.push('-c:v');
            command.push(data.vcodec);

            if (hasVideoCode) {
                command.push('-crf');
                command.push(data.crf);

                command.push('-preset');
                command.push(data.preset);

                if (data.profile !== 'ffmpeg') {
                    command.push('-profile:v');
                    command.push(data.profile);
                    if (data.level !== 'ffmpeg') {
                        command.push('-level');
                        command.push(data.level);
                    }
                }

                if (data.faststart) {
                    command.push('-movflags');
                    command.push('+faststart');
                    flags.push('+global_header');
                }

                if (data.yuv420p) {
                    command.push('-pix_fmt');
                    command.push('yuv420p');
                }

                if (hasVideoFilters) {
                    command.push('-vf');
                    const filters = [];
                    if (hasResize) {
                        filters.push(`scale=-2:${data.height}`);
                    }
                    if (hasFPS) {
                        filters.push(`fps=fps=${data.fps}`);
                    }
                    command.push(`"${filters.join(',')}"`);
                }
            }
        } else {
            command.push('-vn');
        }

        if (hasAudio) {
            command.push('-c:a');
            command.push(data.acodec);

            if (hasAudioCode) {
                //  -b:a 128k
                command.push('-b:a');
                command.push(`${data.ba}k`);
            }
        } else {
            command.push('-an');
        }

        if (data.strip) {
            command.push('-bitexact');
            command.push('-map_metadata');
            command.push('-1');
            command.push('-vbsf');
            command.push('filter_units=remove_types=6');
        }

        if (data.create) {
            command.push('-metadata');
            command.push(`creation_time="${time}"`);
        }

        if (data.title && data.title.length > 0) {
            command.push('-metadata');
            command.push(`title="${data.title}"`);
        }

        if (hasVideo) {
            command.push('-metadata:s:v:0');
            command.push(`language=${data.vlang}`);
        }

        if (hasAudio) {
            command.push('-metadata:s:a:0');
            command.push(`language=${data.vlang}`);
        }

        if (flags.length > 1) {
            command = command.concat(flags);
        }

        command.push(output);

        cli.innerText = command.join(' ');
    };
    handle();

    selectAll('input').forEach((el) => el.addEventListener('input', handle));
    selectAll('select').forEach((el) => el.addEventListener('change', handle));
    document.getElementById('copy').addEventListener('click', () => {
        const cli = document.getElementById('cli');
        copy(cli.innerText).then(() => message('ffmpeg command copied!'));
    });
</script>

</body>
</html>
